<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BubbleSort</title>

    <!--RWD-->
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <!--CARGAR ESTILOS EXTERNOS-->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Bootstrap optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!--CARGAR ESTILOS LOCALES-->
    <!--
       Animante.css (para crear animaciones predefinidas en clases)
       @see: https://github.com/daneden/animate.css
    -->
    <!--<style rel="stylesheet" href="../../css/animate.css"></style>-->
    <!-- Mediante CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <style>
        /*HEADER*/

        header.main {
            background-color: teal;
            color: #fff;
        }

        /*CUERPO*/

        /*CHANGES[x]: posicionamiento mediante FLEX*/

        /*@see: https://css-tricks.com/snippets/css/a-guide-to-flexbox/*/

        .container-flex {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-evenly;
            align-items: center;
        }

        .row {
            margin: 20px 0;
        }

        @keyframes mostrar {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        .box {
            display: inline-block;
            width: 50px;
            height: auto;
            background-color: grey;
            color: #fff;
            font-size: 2em;
            text-align: center;
            border-radius: 5px;
            /*margin: 5px 5px 0 0;*/
            position: relative;
        }

        /*.boxClose:hover {
            animation: shake 0.82s cubic-bezier(.36, .07, .19, .97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }*/

        /*efecto de animación "shake" al hover*/

        /* compatibilidad con Chorme, Safari, Opera */

        @-webkit-keyframes shake {
            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        @keyframes shake {
            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .boxClose {
            position: absolute;
            z-index: 5;
            left: 35px;
            top: -8px;
            color: black;
            background-color: white;
            border-radius: 50%;
        }

        /* BOTONES */

        .center-block {
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <header class="main">
        <div class="container">
            <h1>Bubble Sort</h1>
        </div>
    </header>


    <div class="container">
        <section class="main">
            <div class="row">
                <form class="form-inline">
                    <div class="col-xs-3 col-sm-2">
                        <div class="form-group">
                            <input type="number" min="0" max="300" class="form-control" id="inputNumber">
                        </div>
                    </div>


                    <div class="col-xs-9 col-sm-10">
                        <button type="button" class="btn btn-primary" onclick="anadirNum()">Añadir número</button>
                    </div>

                </form>
            </div>

            <div id="divAlertas"></div>

            <div class="row col-sm-12">
                <div class="panel panel-danger">
                    <!-- Default panel contents -->
                    <div class="panel-heading" id="cntNumDesHeader">Números desordenados</div>
                    <div class="panel-body container-flex" id="cntNumDes">

                        <!--Ejemplo: -->
                        <!--<span class="box">72<i class="boxClose fas fa-times-circle fa-xs" data-index="0" onclick="borrarNum()"></i></span>-->

                    </div>
                </div>
            </div>

            <div class="row col-sm-12">
                <div class="panel panel-success">
                    <div class="panel-heading">Números ordenados</div>
                    <div class="panel-body container-flex" id="cntNumOrd">

                    </div>
                </div>
            </div>

            <div class="row col-sm-12">
                <div>
                    <button type="button" class="btn btn-success btn-lg center-block" onclick="ordenacionEnBurbuja()">ORDENAR</button>
                    <button type="button" class="btn btn-danger btn-lg center-block" onclick="reset()">RESTABLECER</button>
                </div>
            </div>

        </section>
    </div>

    <!--SCRIPT LOCAL-->
    <script>
        // Variables del DOM
        var inputNum = document.getElementById("inputNumber");
        var cntNumDesHeader = document.getElementById("cntNumDesHeader");
        var cntNumDes = document.getElementById("cntNumDes");
        var cntNumOrd = document.getElementById("cntNumOrd");
        var alerta = document.getElementById("alerta");
        var txtAlerta = document.getElementById("txtAlerta");

        // Constantes
        const MIN = parseInt(inputNum.min); // Valor mínimo
        const MAX = parseInt(inputNum.max); // Valor máximo
        const MAX_ELEM = 10; // Máximo de elementos de las lista

        // Códigos de alerta
        const emptyInput = "emptyInput";
        const notMinLenth = "notMinLenth";
        const outOfRange = "outOfRange";
        const listaCompleta = "listaCompleta";

        // Variables globales
        var listNum = []; // Array de números
        var listNumOrd = []; //Array de números ya ordenados
        var contNum = 0; // tamaño del array 'listNum'



        // FUNCIONES

        /**
         *   Función para añadir un nuevo número a la lista desordenada
         **/
        // FUTURE[x]: Habrá que limpiar (sobrescribir) las listas con // lista.innerHTML = "" // al pulsar el botón ORDENAR
        function anadirNum() {

            // var
            var spanNumero = '<span class="box" data-index="##indiceNum##">##newNum##<i class="boxClose fas fa-times-circle fa-xs" onclick="borrarNum(this)" onmouseover="shake(this.parentElement)"></i></span>';
            var nuevoSpan = "";
            // limpiar newNum de 0s a la izquierda
            let newNum = parseInt(inputNum.value, 10);

            if (isNaN(newNum)) {
                mostrarAlertas(emptyInput);
            } else if (validarNumero(newNum)) {
                // Mostrar en consola nuevo número
                console.debug("Nuevo número %i", newNum);
                if (contNum < MAX_ELEM) {
                    // crear nuevo elemento <span> con el nuevo número
                    // Forma simple: cntNumDes.innerHTML = "<span class='box'>" + newNum + "</span>"
                    nuevoSpan = spanNumero.replace("##newNum##", newNum);
                    // Insertar el index de la posición para el método de borrado
                    nuevoSpan = nuevoSpan.replace("##indiceNum##", contNum);
                    contNum++;
                    // añadir número a la lista de números desordenada, SI tiene menos de 10 elementos
                    listNum.push(newNum);
                } else {
                    mostrarAlertas(listaCompleta);
                }
                cntNumDes.innerHTML += nuevoSpan;
                cntNumDesHeader.innerHTML = "Números desordenados: [" + contNum + "]";
                if (contNum < MAX_ELEM) {
                    animarNuevaEntrada(contNum - 1);
                }
            }
            // limpiar el input y devolver focus
            inputNum.value = "";
            inputNum.focus();
            newNum = undefined;
        }


        /*
         *   Función para validar que el nuevo número a añadir está en el rango definido
         */
        function validarNumero(num) {

            var esValido = true;

            if (!(MIN <= num && num <= MAX)) {
                //alert("Debe insertar un número entre " + MIN + " y " + MAX);
                mostrarAlertas(outOfRange);
                console.info("Debe insertar un número entre " + MIN + " y " + MAX);
                esValido = false;
            }
            return esValido;
        }


        /**
            Función para borrar el número de la lista ordenada
            PRE: se pulsa en el icono de eliminar 'x' de un elemento de la lista ordenada
            POST: se elimina ese número, se reordena el array con el resto de números y se organizan sus indices
        **/
        function borrarNum(elem) {

            //var
            var pos = elem.parentElement.dataset.index;
            console.debug("Posición eliminada: %s", pos);

            // TODO[x]: eliminar elemento con "pos" del array "listNum", de la UI y reordenar los indices
            /*listNum.splice(pos, 1);*/
            // FIXME[x]: borra mal los números después de limpiar los NULL. limpiarNulls debería dejar igual el array listNum
            listNum[pos] = null;
            contNum--;
            console.debug("Lista desordenadas post-borrado: " + listNum);
            elem.parentElement.style.display = "none"; // desaparece de la UI
            cntNumDesHeader.innerHTML = "Números desordenados: [" + contNum + "]"; // actualizar el contador de la cabecera
        }

        /**
            Función para ordenar una lista de números: metodología de la burbuja "BubleSort"
            PRE: obtiene una lista de números desordenados
            POST: devuelve la misma lista de números ordenada
        */
        function ordenacionEnBurbuja() {

            // var
            var spanNumero = '<span class="box" data-index="##indiceNum##">##newNum##</span>';

            // cloar el array desordenado y limpiarlo de NULLS
            listNumOrd = listNum.slice();
            listNumOrd = limpiarArrayDeNulls(listNumOrd);
            console.debug("Lista a ordenar sin NULLS: " + listNumOrd);

            if (listNumOrd.length < 2) {
                mostrarAlertas(notMinLenth);
            } else {
                // variables de posiciones
                var sig;
                var ult_pos = listNumOrd.length;
                var iteracion = 0;
                var temp;

                // variables de stop
                var stop = false;
                var sin_cambios;

                // pintar lista en su estado inicial:
                console.debug("Lista inicial: " + listNumOrd);

                // iterar tantas veces como posiciones tiene el array o hasta que la lista este ordenada
                while (iteracion < listNumOrd.length && !stop) {
                    // preparar las posición para la siguiente iteración
                    sig = 1; // se compara el par de las posiciones 'sig-1' y su posterior 'sig'
                    ult_pos--; // en cada iteración se comprar una posición menos, dado que la última posición ya está ocupara por el mayor valor
                    sin_cambios = 0;
                    // comparar las posiciones inmediatas y ordenarlas de menor a mayor
                    for (var i = 0; i < ult_pos; i++) {
                        if (parseInt(listNumOrd[sig - 1]) > parseInt(listNumOrd[sig])) {
                            // invertir orden el los valores
                            temp = listNumOrd[sig - 1];
                            listNumOrd[sig - 1] = listNumOrd[sig];
                            listNumOrd[sig] = temp;
                        } else {
                            // contabilizar las comparaciones sin movimientos
                            sin_cambios++;
                        }
                        // incrementar posicion para comparar el siguiente par
                        sig++;
                    }
                    iteracion++;
                    // comprobar si ha habido cambios en la iteración
                    if (i - 1 < sin_cambios) {
                        stop = true;
                    } else {
                        // mostrar por consola la iteración y el estado actual de la lista
                        console.debug("ITERACIÓN Nº" + iteracion + " : " + listNumOrd);
                    }
                }
                // Mostrar resultado de la lista ordenada y el nº de iteraciones necesarias
                console.debug("Lista ordenada: " + listNumOrd + " en " + (iteracion - 1) + "º iteraciones");

                //return listNumOrd;

                // Limpiar el contenido de la lista ordenada anterior
                cntNumOrd.innerHTML = "";

                // pintar lista ordenada
                for (var j = 0; j < listNumOrd.length; j++) {
                    cntNumOrd.innerHTML += spanNumero.replace("##newNum##", listNumOrd[j]);
                }

                // Mostrar el número de iteraciones necesitadas para ordenar la lista
                //iteraciones.innerHTML = iteracion - 1;
            }


        }

        /*
            Función nativo de los array de Javascript para ordenar
            PRE: array desordenado
            POST: array ordenado atendiendo a la posición del valor Unicode
            @see: https://developer.mozilla.org/es/docs/Web/JavaScript/Referencia/Objetos_globales/Array/sort
        */
        /*function ordenar() {

            // var
            var spanNumero = '<span class="box" data-index="##indiceNum##">##newNum##<i class="boxClose fas fa-times-circle fa-xs" onclick="borrarNum(this)"></i></span>';

            if (listNum.length < 2) {
                mostrarAlertas(notMinLenth);
            } else {
                listNumOrd = listNum.sort();
                console.debug("Lista ordenada: [" + listNumOrd + "]");

                for (var ilistOrd = 0; ilistOrd < listNumOrd.length; ilistOrd++) {
                    cntNumOrd.innerHTML += spanNumero.replace("##newNum##", listNum[ilistOrd]);
                }
            }
        }*/


        /**
            Función para quitar los elementos NULL (previamente borrdos por el usuario en la UI) de un array
            PRE: array con posibles elementos NULL
            POST: array sin elementos NULL
        **/
        function limpiarArrayDeNulls(array) {

            for (var i = 0; i < array.length; i++) {
                if (array[i] === null) {
                    array.splice(i, 1);
                    i--;
                }
            }
            return array;
        }


        /*
         *   Función para mostrar diferentes tipos de alerta y sus mensajes dependiendo del código de error
         *   @errorCode: código de error para especificar el texto de la alerta
         */
        function mostrarAlertas(errorCode) {
            switch (errorCode) {
                case "emptyInput":
                    tipoAlerta = "warning";
                    mensajeAlerta = " Campo de entrada vacio.";
                    break;
                case "outOfRange":
                    tipoAlerta = "warning";
                    mensajeAlerta = " Debe insertar un número en el rango [" + MIN + " - " + MAX + "].";
                    break;
                case "listaCompleta":
                    tipoAlerta = "warning";
                    mensajeAlerta = " La lista ya esta completa.";
                    break;
                case "notMinLenth":
                    tipoAlerta = "warning";
                    mensajeAlerta = " Introduzca al menos 2 números.";
                    break;
                default:
                    break;
            }

            document.getElementById("divAlertas").innerHTML = '<div class="alert alert-' + tipoAlerta + ' alert-dismissible" role="alert"><button type="button" class="close"data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Atención!</strong>' + mensajeAlerta + '</div>';

        }

        /*
         *   Función para restablecer las listas (variables de interzas y de JS)
         */
        function reset() {

            // resetear las listas que se muestran en pantalla
            cntNumDes.innerHTML = "";
            cntNumOrd.innerHTML = "";
            cntNumDesHeader.innerHTML = "Números desordenados";
            // resetear las variables de las listas
            listNum = [];
            contNum = 0;
            listNumOrd = [];

            // Eliminar la alerta en caso de existir
            document.getElementById("divAlertas").innerHTML = "";
        }

        /*FUTURE[x]: cambiar el efecto a una clase propia "shake" y añadirsela a un elemento dinámicamente desde JS cuando haga onmousedown sobre el icono de la cruz*/
        /**
            Función que añade la animación "shake" onmouseover del icono "x"
            @elem: la caja contenedora del número con la X sobre la que se ha pasado el ratón
        **/
        function shake(elem) {

            console.debug("X.mouseover");
            elem.style.animation = "shake 0.82s cubic-bezier(.36, .07, .19, .97) both";
            elem.addEventListener("animationend", function() {
                elem.style = "";
            });

        }

        // TODO[x]: aplicar animación al mostrar nuevo número en UI
        /**
            Función que aplica la animación 'mostrar' al añadir un nuevo número a la lista desordenada de la UI.
        **/
        // FIXME: le aplica la animación a varias cajas cuando añades un nuevo número antes de que la anterior animación temine
        // FIXME: al eliminar y reinsertar nuevos numeros, anima la posición incorrecta
        function animarNuevaEntrada(index) {

            var newBox = document.querySelector("span[data-index='" + String(index) + "']");
            var animando = false;

            if (!animando) {
                newBox.style.animation = "mostrar 0.5s ease-in";
                animando = true;
            }


            newBox.addEventListener("animationend", function() {
                newBox.style = "";
                animando = false;
            });

        }
    </script>
    <!-- CARGA DE SCRIPTS EXTERNOS -->
    <!-- jQuery v2.2.4 minified (dado que no vamos a aplicar cambios en el código de jQuery, usamos la versión 'minified' que viene sin indentar) -->
    <script src="http://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous">
    </script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!--FontAwesome v5.0.6-->
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
</body>
</html>
